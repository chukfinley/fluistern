import { Button, VerticalBox, HorizontalBox, TabWidget, TextEdit, ScrollView, LineEdit, CheckBox } from "std-widgets.slint";

export struct Recording {
    id: int,
    timestamp: string,
    whisper_output: string,
    llm_output: string,
    user_correction: string,
    total_duration_ms: int,
    whisper_duration_ms: int,
    llm_duration_ms: int,
    success: bool,
    error_message: string,
}

export struct Correction {
    whisper_pattern: string,
    intended_text: string,
}

export component RecordingCard inherits Rectangle {
    in property <Recording> recording;
    callback save_correction(string);
    callback delete_recording();

    property <bool> expanded: false;

    background: #1a1a1a;
    border-radius: 4px;
    border-width: 1px;
    border-color: #333;

    VerticalBox {
        padding: 8px;
        spacing: 4px;

        // Header
        HorizontalBox {
            spacing: 8px;

            TouchArea {
                clicked => { expanded = !expanded; }

                HorizontalBox {
                    spacing: 8px;

                    Text {
                        text: expanded ? "▼" : "▶";
                        font-size: 12px;
                        color: #666;
                        vertical-alignment: center;
                    }

                    Text {
                        text: recording.timestamp;
                        color: #666;
                        font-size: 11px;
                        vertical-alignment: center;
                        min-width: 100px;
                    }

                    Text {
                        text: recording.llm_output != "" ? recording.llm_output : recording.whisper_output;
                        color: #aaa;
                        font-size: 12px;
                        horizontal-alignment: left;
                        vertical-alignment: center;
                        overflow: elide;
                    }

                    if recording.user_correction != "": Text {
                        text: "✓";
                        color: #4a9;
                        font-size: 11px;
                        vertical-alignment: center;
                    }

                    if !recording.success: Text {
                        text: "✗";
                        color: #d44;
                        font-size: 11px;
                        vertical-alignment: center;
                    }
                }
            }
        }

        // Details
        if expanded: VerticalBox {
            spacing: 8px;
            padding-top: 4px;

            if recording.total_duration_ms > 0: Text {
                text: recording.total_duration_ms + "ms | W:" + recording.whisper_duration_ms + "ms L:" + recording.llm_duration_ms + "ms";
                font-size: 10px;
                color: #555;
            }

            // Whisper
            VerticalBox {
                spacing: 2px;

                Text {
                    text: "WHISPER";
                    font-size: 10px;
                    color: #666;
                }

                Rectangle {
                    background: #0d0d0d;
                    border-radius: 2px;
                    border-width: 1px;
                    border-color: #222;
                    height: 50px;

                    ScrollView {
                        VerticalLayout {
                            padding: 4px;

                            Text {
                                text: recording.whisper_output;
                                wrap: word-wrap;
                                font-size: 11px;
                                color: #aaa;
                            }
                        }
                    }
                }
            }

            // LLM
            VerticalBox {
                spacing: 2px;

                Text {
                    text: "LLM";
                    font-size: 10px;
                    color: #666;
                }

                Rectangle {
                    background: #0d0d0d;
                    border-radius: 2px;
                    border-width: 1px;
                    border-color: #222;
                    height: 50px;

                    ScrollView {
                        VerticalLayout {
                            padding: 4px;

                            Text {
                                text: recording.llm_output;
                                wrap: word-wrap;
                                font-size: 11px;
                                color: #aaa;
                            }
                        }
                    }
                }
            }

            // Correction
            VerticalBox {
                spacing: 2px;

                Text {
                    text: "CORRECTION";
                    font-size: 10px;
                    color: #4a9;
                }

                Rectangle {
                    background: #0a0f0a;
                    border-radius: 2px;
                    border-width: 1px;
                    border-color: #4a9;
                    height: 60px;

                    ScrollView {
                        correction_edit := TextEdit {
                            text: recording.user_correction != "" ? recording.user_correction : recording.llm_output;
                            wrap: word-wrap;
                            font-size: 11px;
                        }
                    }
                }
            }

            // Buttons
            HorizontalBox {
                spacing: 6px;

                Button {
                    text: "Save";
                    clicked => {
                        save_correction(correction_edit.text);
                    }
                }

                Button {
                    text: "Delete";
                    clicked => {
                        delete_recording();
                    }
                }
            }

            if recording.error_message != "": Text {
                text: "Error: " + recording.error_message;
                color: #d44;
                font-size: 11px;
                wrap: word-wrap;
            }
        }
    }
}

export component MainWindow inherits Window {
    title: "Flüstern";
    preferred-width: 900px;
    preferred-height: 700px;
    background: #0d0d0d;

    callback refresh();
    callback save_correction(int, string);
    callback delete_recording(int);
    callback save_settings(string, string, string, bool, bool, string);
    callback reset_prompt();
    callback clear_logs();

    in property <[Recording]> recordings: [];
    in property <[Correction]> corrections: [];
    in property <string> logs: "";
    in property <string> api_key: "";
    in property <string> mic_source: "";
    in property <string> language: "";
    in property <bool> notifications: true;
    in property <bool> tray_icon: true;
    in property <string> system_prompt: "";

    VerticalBox {
        padding: 0px;

        // Header
        Rectangle {
            height: 40px;
            background: #1a1a1a;

            HorizontalBox {
                padding: 8px;
                spacing: 8px;

                Text {
                    text: "Flüstern";
                    color: #aaa;
                    font-size: 14px;
                    font-weight: 600;
                    vertical-alignment: center;
                }

                Rectangle { } // Spacer

                Button {
                    text: "↻";
                    clicked => { refresh(); }
                }
            }
        }

        // Main content
        TabWidget {
            // History
            Tab {
                title: "History";

                Rectangle {
                    background: #0d0d0d;

                    VerticalBox {
                        padding: 8px;

                        if recordings.length == 0: VerticalBox {
                            alignment: center;

                            Text {
                                text: "No recordings yet";
                                color: #555;
                                horizontal-alignment: center;
                                font-size: 12px;
                            }
                        }

                        if recordings.length > 0: ScrollView {
                            viewport-height: recordings.length * 100px;

                            VerticalBox {
                                spacing: 4px;

                                for rec[idx] in recordings: RecordingCard {
                                    recording: rec;
                                    save_correction(text) => {
                                        save_correction(rec.id, text);
                                    }
                                    delete_recording => {
                                        delete_recording(rec.id);
                                    }
                                }
                            }
                        }
                    }
                }
            }

            // Logs
            Tab {
                title: "Logs";

                Rectangle {
                    background: #0d0d0d;

                    VerticalBox {
                        padding: 8px;
                        spacing: 6px;

                        HorizontalBox {
                            spacing: 8px;

                            Text {
                                text: "Debug Logs";
                                color: #666;
                                font-size: 11px;
                                vertical-alignment: center;
                            }

                            Rectangle { }

                            Button {
                                text: "Clear";
                                clicked => { clear_logs(); }
                            }
                        }

                        Rectangle {
                            background: #000;
                            border-radius: 2px;

                            ScrollView {
                                TextEdit {
                                    text: logs;
                                    font-size: 10px;
                                    read-only: true;
                                }
                            }
                        }
                    }
                }
            }

            // Settings
            Tab {
                title: "Settings";

                Rectangle {
                    background: #0d0d0d;

                    ScrollView {
                        VerticalBox {
                            padding: 12px;
                            spacing: 12px;

                            // API
                            VerticalBox {
                                spacing: 4px;

                                Text {
                                    text: "API";
                                    font-size: 11px;
                                    color: #666;
                                }

                                api_entry := LineEdit {
                                    text: api_key;
                                    placeholder-text: "Groq API Key";
                                }
                            }

                            // Recording
                            VerticalBox {
                                spacing: 4px;

                                Text {
                                    text: "Recording";
                                    font-size: 11px;
                                    color: #666;
                                }

                                mic_entry := LineEdit {
                                    text: mic_source;
                                    placeholder-text: "Mic source (empty = default)";
                                }

                                lang_entry := LineEdit {
                                    text: language;
                                    placeholder-text: "Language (de, en, ...)";
                                }
                            }

                            // Interface
                            VerticalBox {
                                spacing: 4px;

                                Text {
                                    text: "Interface";
                                    font-size: 11px;
                                    color: #666;
                                }

                                notif_check := CheckBox {
                                    text: "Notifications";
                                    checked: notifications;
                                }

                                tray_check := CheckBox {
                                    text: "Tray Icon";
                                    checked: tray_icon;
                                }
                            }

                            // System prompt
                            VerticalBox {
                                spacing: 4px;

                                HorizontalBox {
                                    spacing: 8px;

                                    Text {
                                        text: "System Prompt";
                                        font-size: 11px;
                                        color: #666;
                                    }

                                    Rectangle { }

                                    Button {
                                        text: "Reset";
                                        clicked => { reset_prompt(); }
                                    }
                                }

                                Rectangle {
                                    background: #0a0a0a;
                                    border-radius: 2px;
                                    height: 150px;

                                    prompt_edit := TextEdit {
                                        text: system_prompt;
                                        wrap: word-wrap;
                                        font-size: 10px;
                                    }
                                }
                            }

                            Button {
                                text: "Save Settings";
                                clicked => {
                                    save_settings(
                                        api_entry.text,
                                        mic_entry.text,
                                        lang_entry.text,
                                        notif_check.checked,
                                        tray_check.checked,
                                        prompt_edit.text
                                    );
                                }
                            }
                        }
                    }
                }
            }

            // Corrections
            Tab {
                title: "Corrections";

                Rectangle {
                    background: #0d0d0d;

                    VerticalBox {
                        padding: 8px;
                        spacing: 8px;

                        Text {
                            text: "Saved Corrections";
                            font-size: 12px;
                            color: #aaa;
                        }

                        if corrections.length == 0: Text {
                            text: "No corrections yet";
                            color: #555;
                            font-size: 11px;
                        }

                        if corrections.length > 0: ScrollView {
                            VerticalBox {
                                spacing: 4px;

                                for corr in corrections: HorizontalBox {
                                    spacing: 8px;
                                    padding: 4px;

                                    Text {
                                        text: "\"" + corr.whisper_pattern + "\"";
                                        color: #666;
                                        font-size: 11px;
                                    }

                                    Text {
                                        text: "→";
                                        color: #555;
                                        font-size: 11px;
                                    }

                                    Text {
                                        text: "\"" + corr.intended_text + "\"";
                                        color: #4a9;
                                        font-size: 11px;
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
